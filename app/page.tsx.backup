'use client'

import { useState, useEffect } from 'react'

// Simple authentication component
const LoginPage = ({ onLogin }: { onLogin: (username: string, password: string) => void }) => {
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (username && password) {
      onLogin(username, password)
    } else {
      setError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin')
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div>
          <div className="mx-auto h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center">
            <span className="text-2xl">üîê</span>
          </div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            ƒêƒÉng nh·∫≠p
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            Ch·ªâ d√†nh cho ng∆∞·ªùi d√πng ƒë∆∞·ª£c ·ªßy quy·ªÅn
          </p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="username" className="sr-only">
                T√™n ƒëƒÉng nh·∫≠p
              </label>
              <input
                id="username"
                name="username"
                type="text"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="T√™n ƒëƒÉng nh·∫≠p"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                M·∫≠t kh·∫©u
              </label>
              <input
                id="password"
                name="password"
                type="password"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                placeholder="M·∫≠t kh·∫©u"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          {error && (
            <div className="text-red-600 text-sm text-center">
              {error}
            </div>
          )}

          <div>
            <button
              type="submit"
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
            >
              ƒêƒÉng nh·∫≠p
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}

// User Management Modal
const UserManagementModal = ({
  users,
  newUser,
  setNewUser,
  addUser,
  removeUser,
  onClose
}: {
  users: {username: string, password: string, role: string}[],
  newUser: {username: string, password: string, role: string},
  setNewUser: (user: {username: string, password: string, role: string}) => void,
  addUser: () => void,
  removeUser: (username: string) => void,
  onClose: () => void
}) => {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-100">
        <div className="flex items-center mb-6">
          <div className="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-4">
            <span className="text-white text-xl">üë•</span>
          </div>
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Qu·∫£n l√Ω User</h2>
            <p className="text-gray-600 text-sm">T·∫°o t√†i kho·∫£n cho ƒë·∫°i l√Ω</p>
          </div>
        </div>

        {/* Add New User Form */}
        <div className="bg-gray-50 p-6 rounded-xl mb-6">
          <h3 className="text-lg font-semibold mb-4 text-gray-800">Th√™m User M·ªõi</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input
              type="text"
              placeholder="Username"
              value={newUser.username}
              onChange={(e) => setNewUser({...newUser, username: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="password"
              placeholder="Password"
              value={newUser.password}
              onChange={(e) => setNewUser({...newUser, password: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <select
              value={newUser.role}
              onChange={(e) => setNewUser({...newUser, role: e.target.value})}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="agent">Agent (ƒê·∫°i l√Ω)</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button
            onClick={addUser}
            className="mt-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-2 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
          >
            ‚ûï Th√™m User
          </button>
        </div>

        {/* User List */}
        <div className="bg-white border border-gray-200 rounded-xl">
          <div className="px-6 py-4 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-800">Danh s√°ch User</h3>
          </div>
          <div className="divide-y divide-gray-200">
            {users.map((user, index) => (
              <div key={index} className="px-6 py-4 flex items-center justify-between">
                <div>
                  <div className="font-medium text-gray-900">{user.username}</div>
                  <div className="text-sm text-gray-500">Role: {user.role}</div>
                </div>
                <div className="flex items-center space-x-2">
                  <span className={`px-2 py-1 text-xs rounded-full ${
                    user.role === 'admin'
                      ? 'bg-purple-100 text-purple-800'
                      : 'bg-blue-100 text-blue-800'
                  }`}>
                    {user.role}
                  </span>
                  {user.username !== 'admin' && (
                    <button
                      onClick={() => removeUser(user.username)}
                      className="text-red-600 hover:text-red-800 p-1"
                    >
                      üóëÔ∏è
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="flex justify-end mt-6">
          <button
            onClick={onClose}
            className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl transition-all duration-200 font-semibold"
          >
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  )
}

// Cart Modal Component
const CartModal = ({
  cart,
  updateQuantity,
  removeFromCart,
  clearCart,
  onClose,
  onCheckout
}: {
  cart: any[],
  updateQuantity: (id: string, quantity: number) => void,
  removeFromCart: (id: string) => void,
  clearCart: () => void,
  onClose: () => void,
  onCheckout: () => void
}) => {
  const total = cart.reduce((sum, item) => {
    const price = parseFloat(item[3]) * 27000
    return sum + (price * item.quantity)
  }, 0)

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-4xl w-full border border-gray-100 max-h-[90vh] overflow-y-auto">
        <div className="flex items-center mb-6">
          <div className="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center mr-4">
            <span className="text-white text-xl">üõí</span>
          </div>
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Gi·ªè h√†ng c·ªßa b·∫°n</h2>
            <p className="text-gray-600 text-sm">{cart.length} s·∫£n ph·∫©m</p>
          </div>
        </div>

        {cart.length === 0 ? (
          <div className="text-center py-12">
            <div className="text-6xl mb-4">üõí</div>
            <h3 className="text-xl font-semibold text-gray-600 mb-2">Gi·ªè h√†ng tr·ªëng</h3>
            <p className="text-gray-500">H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng</p>
          </div>
        ) : (
          <>
            {/* Cart Items */}
            <div className="space-y-4 mb-6">
              {cart.map((item) => {
                const price = parseFloat(item[3]) * 27000
                const subtotal = price * item.quantity

                return (
                  <div key={item.id} className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <h4 className="font-semibold text-gray-800">{item[2]}</h4>
                        <p className="text-sm text-gray-600">
                          Lo·∫°i: {item.cartType === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'} |
                          Gi√°: {price.toLocaleString()} VND |
                          Th·ªùi h·∫°n: {item[5]} ng√†y
                        </p>
                      </div>

                      <div className="flex items-center space-x-4">
                        {/* Quantity Controls */}
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={() => updateQuantity(item.id, item.quantity - 1)}
                            className="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-gray-600"
                          >
                            -
                          </button>
                          <span className="w-12 text-center font-semibold">{item.quantity}</span>
                          <button
                            onClick={() => updateQuantity(item.id, item.quantity + 1)}
                            className="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center text-gray-600"
                          >
                            +
                          </button>
                        </div>

                        {/* Subtotal */}
                        <div className="text-right min-w-[100px]">
                          <p className="font-bold text-green-600">{subtotal.toLocaleString()} VND</p>
                        </div>

                        {/* Remove Button */}
                        <button
                          onClick={() => removeFromCart(item.id)}
                          className="text-red-500 hover:text-red-700 p-2"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>

            {/* Cart Summary */}
            <div className="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
              <div className="flex justify-between items-center">
                <div>
                  <h3 className="text-lg font-bold text-gray-800">T·ªïng c·ªông</h3>
                  <p className="text-sm text-gray-600">{cart.length} s·∫£n ph·∫©m</p>
                </div>
                <div className="text-right">
                  <p className="text-2xl font-bold text-blue-600">{total.toLocaleString()} VND</p>
                  <p className="text-sm text-gray-500">ƒê√£ bao g·ªìm VAT</p>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex justify-between space-x-4">
              <div className="flex space-x-3">
                <button
                  onClick={clearCart}
                  className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl transition-all duration-200 font-semibold"
                >
                  üóëÔ∏è X√≥a t·∫•t c·∫£
                </button>
                <button
                  onClick={onClose}
                  className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl transition-all duration-200 font-semibold"
                >
                  Ti·∫øp t·ª•c mua s·∫Øm
                </button>
              </div>

              <button
                onClick={onCheckout}
                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
              >
                üí≥ Thanh to√°n ({total.toLocaleString()} VND)
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  )

  // Render Cart Modal outside conditional blocks
  return (
    <>
      {(() => {
        if (!isLoggedIn) {
          return <LoginPage onLogin={handleLogin} />
        }

        if (!selectedCountry) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-100 py-12">
              <div className="container mx-auto px-4 max-w-7xl">
                <div className="text-center mb-16">
                  <div className="flex justify-end mb-4 space-x-2">
                    {isAdmin && (
                      <button
                        onClick={() => setShowUserManagement(true)}
                        className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                      >
                        üë• Manage Users
                      </button>
                    )}
                    <button
                      onClick={handleLogout}
                      className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                    >
                      üö™ Logout ({user})
                    </button>
                  </div>
                  <h1 className="text-5xl font-bold text-gray-800 mb-4 drop-shadow-sm">üåç Select Your Country</h1>
                  <p className="text-xl text-gray-600 max-w-2xl mx-auto">Choose a country to explore available SIM card products and services</p>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {uniqueCountries.map((country, index) => {
                    const countryParts = country.split('/');
                    return (
                      <div
                        key={index}
                        className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 hover:scale-102 flex flex-col items-center border border-gray-100 group"
                        onClick={() => setSelectedCountry(country)}
                      >
                        <div className="flex mb-4 space-x-1 justify-center">
                          {countryParts.map((part, i) => (
                            <img
                              key={i}
                              src={getFlagUrl(part.trim())}
                              alt={`${part.trim()} flag`}
                              className="w-12 h-8 rounded-md shadow-sm border border-gray-200 group-hover:border-blue-300 transition-all duration-300"
                            />
                          ))}
                        </div>
                        <h2 className="text-lg font-bold text-gray-800 text-center leading-tight group-hover:text-blue-600 transition-colors duration-300">{country}</h2>
                        <div className="mt-3 w-8 h-1 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                      </div>
                    );
                  })}
                </div>

                {showForm && <Modal />}
                {showUserManagement && (
                  <UserManagementModal
                    users={users}
                    newUser={newUser}
                    setNewUser={setNewUser}
                    addUser={addUser}
                    removeUser={removeUser}
                    onClose={() => setShowUserManagement(false)}
                  />
                )}
              </div>
            </div>
          )
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
            <div className="container mx-auto px-4 max-w-7xl">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-12 bg-white p-6 rounded-2xl shadow-lg">
                <div>
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">üì± Products for {selectedCountry}</h1>
                  <p className="text-gray-600">Browse and order SIM cards with ease</p>
                  <p className="text-sm text-gray-500 mt-1">Welcome, {user}!</p>
                </div>
                <div className="flex space-x-3 mt-4 sm:mt-0">
                  <button
                    onClick={() => setSelectedCountry('')}
                    className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                  >
                    ‚Üê Back to Countries
                  </button>
                  <button
                    onClick={() => setShowCart(true)}
                    className="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md relative"
                  >
                    üõí Gi·ªè h√†ng
                    {cart.length > 0 && (
                      <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">
                        {cart.length}
                      </span>
                    )}
                  </button>
                  {isAdmin && (
                    <button
                      onClick={() => setShowUserManagement(true)}
                      className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                    >
                      üë• Manage Users
                    </button>
                  )}
                  <button
                    onClick={handleLogout}
                    className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                  >
                    üö™ Logout
                  </button>
                </div>
              </div>

              {/* Search Section */}
              <div className="bg-white p-8 rounded-2xl shadow-lg mb-8 border border-gray-100">
                <h2 className="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
                  üîç Filter Products
                </h2>
                <div className="max-w-md">
                  <label className="block text-sm font-semibold text-gray-700 mb-3">Select Duration</label>
                  <select
                    value={searchDays}
                    onChange={e => setSearchDays(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200 text-gray-700"
                  >
                    <option value="">All Days</option>
                    {uniqueDays.map(day => (
                      <option key={day} value={day}>‚è∞ {day} days</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Table */}
              <div className="bg-white rounded-2xl shadow-xl overflow-x-auto border border-gray-100">
                <table className="table-auto w-full">
                  <thead className="bg-gradient-to-r from-blue-600 to-indigo-600">
                    <tr>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Type</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Country</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Name</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price VND</th>
                      <th className="hidden md:table-cell px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Operations</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Days</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Esim</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Sim V·∫≠t L√Ω</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {filteredData.map((item: any, index: number) => (
                      <tr key={index} className={`hover:bg-blue-50 transition-colors duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{item[0]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[1].replace(/[^\x00-\x7F]+/g, '').trim()}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">{item[2]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item[3]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">{(parseFloat(item[3]) * 27000).toLocaleString()} VND</td>
                        <td className="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[4]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[5]} days</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          <div className="flex flex-col space-y-3">
                            {/* eSIM Section */}
                            <div className="flex items-center space-x-2">
                              <span className="text-xs font-medium text-gray-600 w-12">eSIM:</span>
                              <div className="flex items-center space-x-1">
                                <button
                                  onClick={() => decrementProductQuantity(item[2], 'esim')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  -
                                </button>
                                <span className="w-8 text-center text-sm font-medium">
                                  {getProductQuantity(item[2], 'esim')}
                                </span>
                                <button
                                  onClick={() => incrementProductQuantity(item[2], 'esim')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  +
                                </button>
                              </div>
                              <button
                                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                onClick={() => addToCart(item, 'esim', getProductQuantity(item[2], 'esim'))}
                              >
                                üõí Th√™m
                              </button>
                            </div>

                            {/* Physical SIM Section */}
                            <div className="flex items-center space-x-2">
                              <span className="text-xs font-medium text-gray-600 w-12">V·∫≠t l√Ω:</span>
                              <div className="flex items-center space-x-1">
                                <button
                                  onClick={() => decrementProductQuantity(item[2], 'physical')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  -
                                </button>
                                <span className="w-8 text-center text-sm font-medium">
                                  {getProductQuantity(item[2], 'physical')}
                                </span>
                                <button
                                  onClick={() => incrementProductQuantity(item[2], 'physical')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  +
                                </button>
                              </div>
                              <button
                                className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                onClick={() => addToCart(item, 'physical', getProductQuantity(item[2], 'physical'))}
                              >
                                üõí Th√™m
                              </button>
                            </div>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Payment Modal */}
            {showPayment && (
              <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-100">
                  <div className="text-center mb-6">
                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <span className="text-green-600 text-2xl">‚úÖ</span>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Order Confirmed!</h2>
                    <p className="text-gray-600">Please scan the QR code to complete your payment</p>
                  </div>

                  <div className="flex justify-center mb-6">
                    <div className="bg-gray-100 p-4 rounded-xl">
                      {(() => {
                        const amount = Math.round(getCartTotal())

                        if (!currentQrData) {
                          return (
                            <div className="text-center">
                              <div className="w-48 h-48 mx-auto border-2 border-gray-200 rounded-lg flex items-center justify-center">
                                <div className="text-gray-500">ƒêang t·∫°o QR code...</div>
                              </div>
                              <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                              <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                            </div>
                          )
                        }

                        return (
                          <div className="text-center">
                            <img
                              src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentQrData)}&ecc=M`}
                              alt="BIDV VietQR Code"
                              className="w-48 h-48 mx-auto border-2 border-red-200 rounded-lg"
                              onError={(e) => {
                                console.log('QR Code failed to load, trying alternative...')
                                e.currentTarget.src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(currentQrData)}`
                              }}
                            />
                            <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                            <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                            <p className="text-xs text-gray-500 mt-1">Thanh to√°n qua BIDV VietQR</p>
                          </div>
                        )
                      })()}
                    </div>
                  </div>

                  <div className="text-center mb-6">
                    <p className="text-sm text-gray-600 mb-2">Thanh to√°n BIDV VietQR:</p>
                    <p className="text-xs text-gray-500">T√†i kho·∫£n: {bankConfig.accountNumber}</p>
                    <p className="text-xs text-gray-500">Ng√¢n h√†ng: {bankConfig.bankName}</p>
                    <p className="text-xs text-red-600 font-bold">Ch·ªß t√†i kho·∫£n: {bankConfig.accountHolder}</p>
                    <p className="text-xs text-green-600 font-bold text-sm mt-2">S·ªë ti·ªÅn: {getCartTotal().toLocaleString()} VND</p>
                    <p className="text-xs text-red-600 mt-2">üè¶ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                  </div>

                  <div className="flex justify-center space-x-4">
                    <button
                      onClick={() => {
                        setShowPayment(false)
                        setCurrentQrData('')
                        clearCart()
                        alert('C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n! ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong 24h.')
                      }}
                      className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
                    >
                      ‚úÖ ƒê√£ thanh to√°n
                    </button>
                    <button
                      onClick={() => {
                        setShowPayment(false)
                        setCurrentQrData('')
                      }}
                      className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold"
                    >
                      ƒê√≥ng
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )
      })()}

      {/* Render all modals outside conditional blocks */}
      {showForm && <Modal />}
      {showUserManagement && (
        <UserManagementModal
          users={users}
          newUser={newUser}
          setNewUser={setNewUser}
          addUser={addUser}
          removeUser={removeUser}
          onClose={() => setShowUserManagement(false)}
        />
      )}
    </>
  )

  // Render Cart Modal separately to ensure it works
  if (showCart) {
    return (
      <>
        {(() => {
          if (!isLoggedIn) {
            return <LoginPage onLogin={handleLogin} />
          }

          if (!selectedCountry) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-100 py-12">
                <div className="container mx-auto px-4 max-w-7xl">
                  <div className="text-center mb-16">
                    <div className="flex justify-end mb-4 space-x-2">
                      {isAdmin && (
                        <button
                          onClick={() => setShowUserManagement(true)}
                          className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                        >
                          üë• Manage Users
                        </button>
                      )}
                      <button
                        onClick={handleLogout}
                        className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                      >
                        üö™ Logout ({user})
                      </button>
                    </div>
                    <h1 className="text-5xl font-bold text-gray-800 mb-4 drop-shadow-sm">üåç Select Your Country</h1>
                    <p className="text-xl text-gray-600 max-w-2xl mx-auto">Choose a country to explore available SIM card products and services</p>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {uniqueCountries.map((country, index) => {
                      const countryParts = country.split('/');
                      return (
                        <div
                          key={index}
                          className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 hover:scale-102 flex flex-col items-center border border-gray-100 group"
                          onClick={() => setSelectedCountry(country)}
                        >
                          <div className="flex mb-4 space-x-1 justify-center">
                            {countryParts.map((part, i) => (
                              <img
                                key={i}
                                src={getFlagUrl(part.trim())}
                                alt={`${part.trim()} flag`}
                                className="w-12 h-8 rounded-md shadow-sm border border-gray-200 group-hover:border-blue-300 transition-all duration-300"
                              />
                            ))}
                          </div>
                          <h2 className="text-lg font-bold text-gray-800 text-center leading-tight group-hover:text-blue-600 transition-colors duration-300">{country}</h2>
                          <div className="mt-3 w-8 h-1 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
              <div className="container mx-auto px-4 max-w-7xl">
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-12 bg-white p-6 rounded-2xl shadow-lg">
                  <div>
                    <h1 className="text-4xl font-bold text-gray-800 mb-2">üì± Products for {selectedCountry}</h1>
                    <p className="text-gray-600">Browse and order SIM cards with ease</p>
                    <p className="text-sm text-gray-500 mt-1">Welcome, {user}!</p>
                  </div>
                  <div className="flex space-x-3 mt-4 sm:mt-0">
                    <button
                      onClick={() => setSelectedCountry('')}
                      className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                    >
                      ‚Üê Back to Countries
                    </button>
                    <button
                      onClick={() => setShowCart(true)}
                      className="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md relative"
                    >
                      üõí Gi·ªè h√†ng
                      {cart.length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">
                          {cart.length}
                        </span>
                      )}
                    </button>
                    {isAdmin && (
                      <button
                        onClick={() => setShowUserManagement(true)}
                        className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                      >
                        üë• Manage Users
                      </button>
                    )}
                    <button
                      onClick={handleLogout}
                      className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                    >
                      üö™ Logout
                    </button>
                  </div>
                </div>

                {/* Search Section */}
                <div className="bg-white p-8 rounded-2xl shadow-lg mb-8 border border-gray-100">
                  <h2 className="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
                    üîç Filter Products
                  </h2>
                  <div className="max-w-md">
                    <label className="block text-sm font-semibold text-gray-700 mb-3">Select Duration</label>
                    <select
                      value={searchDays}
                      onChange={e => setSearchDays(e.target.value)}
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200 text-gray-700"
                    >
                      <option value="">All Days</option>
                      {uniqueDays.map(day => (
                        <option key={day} value={day}>‚è∞ {day} days</option>
                      ))}
                    </select>
                  </div>
                </div>

                {/* Table */}
                <div className="bg-white rounded-2xl shadow-xl overflow-x-auto border border-gray-100">
                  <table className="table-auto w-full">
                    <thead className="bg-gradient-to-r from-blue-600 to-indigo-600">
                      <tr>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Type</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Country</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Name</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price VND</th>
                        <th className="hidden md:table-cell px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Operations</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Days</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Esim</th>
                        <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Sim V·∫≠t L√Ω</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {filteredData.map((item: any, index: number) => (
                        <tr key={index} className={`hover:bg-blue-50 transition-colors duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{item[0]}</td>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[1].replace(/[^\x00-\x7F]+/g, '').trim()}</td>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">{item[2]}</td>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item[3]}</td>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">{(parseFloat(item[3]) * 27000).toLocaleString()} VND</td>
                          <td className="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[4]}</td>
                          <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[5]} days</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <div className="flex flex-col space-y-3">
                              {/* eSIM Section */}
                              <div className="flex items-center space-x-2">
                                <span className="text-xs font-medium text-gray-600 w-12">eSIM:</span>
                                <div className="flex items-center space-x-1">
                                  <button
                                    onClick={() => decrementProductQuantity(item[2], 'esim')}
                                    className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                  >
                                    -
                                  </button>
                                  <span className="w-8 text-center text-sm font-medium">
                                    {getProductQuantity(item[2], 'esim')}
                                  </span>
                                  <button
                                    onClick={() => incrementProductQuantity(item[2], 'esim')}
                                    className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                  >
                                    +
                                  </button>
                                </div>
                                <button
                                  className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                  onClick={() => addToCart(item, 'esim', getProductQuantity(item[2], 'esim'))}
                                >
                                  üõí Th√™m
                                </button>
                              </div>

                              {/* Physical SIM Section */}
                              <div className="flex items-center space-x-2">
                                <span className="text-xs font-medium text-gray-600 w-12">V·∫≠t l√Ω:</span>
                                <div className="flex items-center space-x-1">
                                  <button
                                    onClick={() => decrementProductQuantity(item[2], 'physical')}
                                    className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                  >
                                    -
                                  </button>
                                  <span className="w-8 text-center text-sm font-medium">
                                    {getProductQuantity(item[2], 'physical')}
                                  </span>
                                  <button
                                    onClick={() => incrementProductQuantity(item[2], 'physical')}
                                    className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                  >
                                    +
                                  </button>
                                </div>
                                <button
                                  className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                  onClick={() => addToCart(item, 'physical', getProductQuantity(item[2], 'physical'))}
                                >
                                  üõí Th√™m
                                </button>
                              </div>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
        
              {/* Cart Modal */}
              {showCart && (
                <CartModal
                  cart={cart}
                  updateQuantity={updateQuantity}
                  removeFromCart={removeFromCart}
                  clearCart={clearCart}
                  onClose={() => {
                    console.log('Cart modal closed')
                    setShowCart(false)
                  }}
                  onCheckout={() => {
                    console.log('Checkout clicked, opening payment modal')
                    setShowCart(false)
                    setShowPayment(true)
                  }}
                />
              )}
        
              {/* Payment Modal */}
              {showPayment && (
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                  <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-100">
                    <div className="text-center mb-6">
                      <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span className="text-green-600 text-2xl">‚úÖ</span>
                      </div>
                      <h2 className="text-2xl font-bold text-gray-800 mb-2">Order Confirmed!</h2>
                      <p className="text-gray-600">Please scan the QR code to complete your payment</p>
                    </div>

                    <div className="flex justify-center mb-6">
                      <div className="bg-gray-100 p-4 rounded-xl">
                        {(() => {
                          const amount = Math.round(getCartTotal())

                          if (!currentQrData) {
                            return (
                              <div className="text-center">
                                <div className="w-48 h-48 mx-auto border-2 border-gray-200 rounded-lg flex items-center justify-center">
                                  <div className="text-gray-500">ƒêang t·∫°o QR code...</div>
                                </div>
                                <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                                <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                              </div>
                            )
                          }

                          return (
                            <div className="text-center">
                              <img
                                src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentQrData)}&ecc=M`}
                                alt="BIDV VietQR Code"
                                className="w-48 h-48 mx-auto border-2 border-red-200 rounded-lg"
                                onError={(e) => {
                                  console.log('QR Code failed to load, trying alternative...')
                                  e.currentTarget.src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(currentQrData)}`
                                }}
                              />
                              <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                              <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                              <p className="text-xs text-gray-500 mt-1">Thanh to√°n qua BIDV VietQR</p>
                            </div>
                          )
                        })()}
                      </div>
                    </div>

                    <div className="mb-6">
                      <h3 className="text-lg font-bold text-gray-800 mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                      <div className="bg-gray-50 p-4 rounded-xl mb-4">
                        {cart.map((item, index) => {
                          const price = parseFloat(item[3]) * 27000
                          const subtotal = price * item.quantity
                          return (
                            <div key={index} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                              <div>
                                <p className="font-medium text-gray-800">{item[2]}</p>
                                <p className="text-sm text-gray-600">
                                  {item.cartType === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'} √ó {item.quantity}
                                </p>
                              </div>
                              <p className="font-semibold text-green-600">{subtotal.toLocaleString()} VND</p>
                            </div>
                          )
                        })}
                      </div>

                      <div className="text-center">
                        <p className="text-sm text-gray-600 mb-2">Thanh to√°n BIDV VietQR:</p>
                        <p className="text-xs text-gray-500">T√†i kho·∫£n: {bankConfig.accountNumber}</p>
                        <p className="text-xs text-gray-500">Ng√¢n h√†ng: {bankConfig.bankName}</p>
                        <p className="text-xs text-red-600 font-bold">Ch·ªß t√†i kho·∫£n: {bankConfig.accountHolder}</p>
                        <p className="text-lg text-green-600 font-bold mt-2">T·ªïng ti·ªÅn: {getCartTotal().toLocaleString()} VND</p>
                        <p className="text-xs text-red-600 mt-2">üè¶ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                      </div>
                    </div>

                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={() => {
                          setShowPayment(false)
                          setCurrentQrData('')
                          clearCart()
                          alert('C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n! ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong 24h.')
                        }}
                        className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
                      >
                        ‚úÖ ƒê√£ thanh to√°n
                      </button>
                      <button
                        onClick={() => {
                          setShowPayment(false)
                          setCurrentQrData('')
                        }}
                        className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold"
                      >
                        ƒê√≥ng
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )
        })()}

        <CartModal
          cart={cart}
          updateQuantity={updateQuantity}
          removeFromCart={removeFromCart}
          clearCart={clearCart}
          onClose={() => setShowCart(false)}
          onCheckout={() => {
            setShowCart(false)
            setShowPayment(true)
          }}
        />
      </>
    )
  }

  return (
    <>
      {(() => {
        if (!isLoggedIn) {
          return <LoginPage onLogin={handleLogin} />
        }

        if (!selectedCountry) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-100 py-12">
              <div className="container mx-auto px-4 max-w-7xl">
                <div className="text-center mb-16">
                  <div className="flex justify-end mb-4 space-x-2">
                    <div
                      style={{
                        position: 'relative',
                        display: 'inline-block',
                        border: '2px solid red',
                        padding: '5px',
                        background: 'yellow'
                      }}
                    >
                      <button
                        onClick={(e) => {
                          e.preventDefault()
                          e.stopPropagation()
                          alert('üõí CART MENU BUTTON PRESSED! Items: ' + cart.length)
                          console.log('=== CART MENU BUTTON CLICKED ===')
                          console.log('Cart items:', cart.length)
                          console.log('Event:', e)
                        }}
                        onMouseDown={() => console.log('Cart button mouse down')}
                        onMouseUp={() => console.log('Cart button mouse up')}
                        className="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md relative z-10"
                        type="button"
                        style={{
                          pointerEvents: 'auto',
                          cursor: 'pointer',
                          zIndex: 10,
                          position: 'relative'
                        }}
                      >
                      üõí Gi·ªè h√†ng ({cart.length})
                      {cart.length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">
                          {cart.length}
                        </span>
                      )}
                    </button>
                    </div>
                    {isAdmin && (
                      <button
                        onClick={() => setShowUserManagement(true)}
                        className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                      >
                        üë• Manage Users
                      </button>
                    )}
                    <button
                      onClick={handleLogout}
                      className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                    >
                      üö™ Logout ({user})
                    </button>
                  </div>
                  <h1 className="text-5xl font-bold text-gray-800 mb-4 drop-shadow-sm">üåç Select Your Country</h1>
                  <p className="text-xl text-gray-600 max-w-2xl mx-auto">Choose a country to explore available SIM card products and services</p>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {uniqueCountries.map((country, index) => {
                    const countryParts = country.split('/');
                    return (
                      <div
                        key={index}
                        className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 hover:scale-102 flex flex-col items-center border border-gray-100 group"
                        onClick={() => setSelectedCountry(country)}
                      >
                        <div className="flex mb-4 space-x-1 justify-center">
                          {countryParts.map((part, i) => (
                            <img
                              key={i}
                              src={getFlagUrl(part.trim())}
                              alt={`${part.trim()} flag`}
                              className="w-12 h-8 rounded-md shadow-sm border border-gray-200 group-hover:border-blue-300 transition-all duration-300"
                            />
                          ))}
                        </div>
                        <h2 className="text-lg font-bold text-gray-800 text-center leading-tight group-hover:text-blue-600 transition-colors duration-300">{country}</h2>
                        <div className="mt-3 w-8 h-1 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                      </div>
                    );
                  })}
                </div>

                {showForm && <Modal />}
                {showUserManagement && (
                  <UserManagementModal
                    users={users}
                    newUser={newUser}
                    setNewUser={setNewUser}
                    addUser={addUser}
                    removeUser={removeUser}
                    onClose={() => setShowUserManagement(false)}
                  />
                )}
              </div>
            </div>
          )
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
            <div className="container mx-auto px-4 max-w-7xl">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-12 bg-white p-6 rounded-2xl shadow-lg">
                <div>
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">üì± Products for {selectedCountry}</h1>
                  <p className="text-gray-600">Browse and order SIM cards with ease</p>
                  <p className="text-sm text-gray-500 mt-1">Welcome, {user}!</p>
                </div>
                <div className="flex space-x-3 mt-4 sm:mt-0">
                  <button
                    onClick={() => setSelectedCountry('')}
                    className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                  >
                    ‚Üê Back to Countries
                  </button>
                  <div
                    style={{
                      position: 'relative',
                      display: 'inline-block',
                      border: '2px solid red',
                      padding: '5px',
                      background: 'yellow'
                    }}
                  >
                    <button
                      onClick={(e) => {
                        e.preventDefault()
                        e.stopPropagation()
                        alert('üõí CART MENU BUTTON PRESSED! Items: ' + cart.length)
                        console.log('=== CART MENU BUTTON CLICKED ===')
                        console.log('Cart items:', cart.length)
                        console.log('Event:', e)
                      }}
                      onMouseDown={() => console.log('Cart button mouse down')}
                      onMouseUp={() => console.log('Cart button mouse up')}
                      className="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md relative z-10"
                      type="button"
                      style={{
                        pointerEvents: 'auto',
                        cursor: 'pointer',
                        zIndex: 10,
                        position: 'relative'
                      }}
                    >
                    üõí Gi·ªè h√†ng ({cart.length})
                    {cart.length > 0 && (
                      <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">
                        {cart.length}
                      </span>
                    )}
                  </button>
                  </div>
                  {isAdmin && (
                    <button
                      onClick={() => setShowUserManagement(true)}
                      className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                    >
                      üë• Manage Users
                    </button>
                  )}
                  <button
                    onClick={handleLogout}
                    className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
                  >
                    üö™ Logout
                  </button>
                </div>
              </div>

              {/* Search Section */}
              <div className="bg-white p-8 rounded-2xl shadow-lg mb-8 border border-gray-100">
                <h2 className="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
                  üîç Filter Products
                </h2>
                <div className="max-w-md">
                  <label className="block text-sm font-semibold text-gray-700 mb-3">Select Duration</label>
                  <select
                    value={searchDays}
                    onChange={e => setSearchDays(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200 text-gray-700"
                  >
                    <option value="">All Days</option>
                    {uniqueDays.map(day => (
                      <option key={day} value={day}>‚è∞ {day} days</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* Table */}
              <div className="bg-white rounded-2xl shadow-xl overflow-x-auto border border-gray-100">
                <table className="table-auto w-full">
                  <thead className="bg-gradient-to-r from-blue-600 to-indigo-600">
                    <tr>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Type</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Country</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Name</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price VND</th>
                      <th className="hidden md:table-cell px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Operations</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Days</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Esim</th>
                      <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Sim V·∫≠t L√Ω</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {filteredData.map((item: any, index: number) => (
                      <tr key={index} className={`hover:bg-blue-50 transition-colors duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{item[0]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[1].replace(/[^\x00-\x7F]+/g, '').trim()}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">{item[2]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item[3]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">{(parseFloat(item[3]) * 27000).toLocaleString()} VND</td>
                        <td className="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[4]}</td>
                        <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[5]} days</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          <div className="flex flex-col space-y-3">
                            {/* eSIM Section */}
                            <div className="flex items-center space-x-2">
                              <span className="text-xs font-medium text-gray-600 w-12">eSIM:</span>
                              <div className="flex items-center space-x-1">
                                <button
                                  onClick={() => decrementProductQuantity(item[2], 'esim')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  -
                                </button>
                                <span className="w-8 text-center text-sm font-medium">
                                  {getProductQuantity(item[2], 'esim')}
                                </span>
                                <button
                                  onClick={() => incrementProductQuantity(item[2], 'esim')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  +
                                </button>
                              </div>
                              <button
                                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                onClick={() => addToCart(item, 'esim', getProductQuantity(item[2], 'esim'))}
                              >
                                üõí Th√™m
                              </button>
                            </div>

                            {/* Physical SIM Section */}
                            <div className="flex items-center space-x-2">
                              <span className="text-xs font-medium text-gray-600 w-12">V·∫≠t l√Ω:</span>
                              <div className="flex items-center space-x-1">
                                <button
                                  onClick={() => decrementProductQuantity(item[2], 'physical')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  -
                                </button>
                                <span className="w-8 text-center text-sm font-medium">
                                  {getProductQuantity(item[2], 'physical')}
                                </span>
                                <button
                                  onClick={() => incrementProductQuantity(item[2], 'physical')}
                                  className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                                >
                                  +
                                </button>
                              </div>
                              <button
                                className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                                onClick={() => addToCart(item, 'physical', getProductQuantity(item[2], 'physical'))}
                              >
                                üõí Th√™m
                              </button>
                            </div>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Payment Modal */}
            {showPayment && (
              <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-100">
                  <div className="text-center mb-6">
                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <span className="text-green-600 text-2xl">‚úÖ</span>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Order Confirmed!</h2>
                    <p className="text-gray-600">Please scan the QR code to complete your payment</p>
                  </div>

                  <div className="flex justify-center mb-6">
                    <div className="bg-gray-100 p-4 rounded-xl">
                      {(() => {
                        const amount = Math.round(getCartTotal())

                        if (!currentQrData) {
                          return (
                            <div className="text-center">
                              <div className="w-48 h-48 mx-auto border-2 border-gray-200 rounded-lg flex items-center justify-center">
                                <div className="text-gray-500">ƒêang t·∫°o QR code...</div>
                              </div>
                              <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                              <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                            </div>
                          )
                        }

                        return (
                          <div className="text-center">
                            <img
                              src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentQrData)}&ecc=M`}
                              alt="BIDV VietQR Code"
                              className="w-48 h-48 mx-auto border-2 border-red-200 rounded-lg"
                              onError={(e) => {
                                console.log('QR Code failed to load, trying alternative...')
                                e.currentTarget.src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(currentQrData)}`
                              }}
                            />
                            <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                            <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                            <p className="text-xs text-gray-500 mt-1">Thanh to√°n qua BIDV VietQR</p>
                          </div>
                        )
                      })()}
                    </div>
                  </div>

                  <div className="mb-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                    <div className="bg-gray-50 p-4 rounded-xl mb-4">
                      {cart.map((item, index) => {
                        const price = parseFloat(item[3]) * 27000
                        const subtotal = price * item.quantity
                        return (
                          <div key={index} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                            <div>
                              <p className="font-medium text-gray-800">{item[2]}</p>
                              <p className="text-sm text-gray-600">
                                {item.cartType === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'} √ó {item.quantity}
                              </p>
                            </div>
                            <p className="font-semibold text-green-600">{subtotal.toLocaleString()} VND</p>
                          </div>
                        )
                      })}
                    </div>

                    <div className="text-center">
                      <p className="text-sm text-gray-600 mb-2">Thanh to√°n BIDV VietQR:</p>
                      <p className="text-xs text-gray-500">T√†i kho·∫£n: {bankConfig.accountNumber}</p>
                      <p className="text-xs text-gray-500">Ng√¢n h√†ng: {bankConfig.bankName}</p>
                      <p className="text-xs text-red-600 font-bold">Ch·ªß t√†i kho·∫£n: {bankConfig.accountHolder}</p>
                      <p className="text-lg text-green-600 font-bold mt-2">T·ªïng ti·ªÅn: {getCartTotal().toLocaleString()} VND</p>
                      <p className="text-xs text-red-600 mt-2">üè¶ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
                    </div>
                  </div>

                  <div className="flex justify-center space-x-4">
                    <button
                      onClick={() => {
                        setShowPayment(false)
                        setCurrentQrData('')
                        clearCart()
                        alert('C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n! ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong 24h.')
                      }}
                      className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
                    >
                      ‚úÖ ƒê√£ thanh to√°n
                    </button>
                    <button
                      onClick={() => {
                        setShowPayment(false)
                        setCurrentQrData('')
                      }}
                      className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold"
                    >
                      ƒê√≥ng
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )
      })()}

      {/* Render all modals outside conditional blocks */}
      {showForm && <Modal />}
      {showUserManagement && (
        <UserManagementModal
          users={users}
          newUser={newUser}
          setNewUser={setNewUser}
          addUser={addUser}
          removeUser={removeUser}
          onClose={() => setShowUserManagement(false)}
        />
      )}
    </>
  )
}

export default function Home() {
  // Authentication state - moved to top
  const [isLoggedIn, setIsLoggedIn] = useState(false)
  const [user, setUser] = useState<string>('')

  // BIDV VietQR Configuration
  const bankConfig = {
    accountNumber: '8864555896',
    bankName: 'BIDV',
    accountHolder: 'DAO VIET ANH',
    bankCode: 'BIDV',
    qrTemplate: '00020101021238540010A00000072701240006970418011088645558960208QRIBFTTA53037045405100005802VN63040517',
  }

  // Generate QR data with dynamic amount
  const generateQrData = (amount: number) => {
    const amountStr = Math.round(amount).toString()
    const amountLength = amountStr.length.toString().padStart(2, '0')
    const amountField = `54${amountLength}${amountStr}`
    return bankConfig.qrTemplate.replace('540510000', amountField)
  }

  const [data, setData] = useState<any[]>([])
  const [selectedCountry, setSelectedCountry] = useState('')
  const [searchDays, setSearchDays] = useState('')
  const [showForm, setShowForm] = useState(false)
  const [selectedProduct, setSelectedProduct] = useState<any>(null)
  const [formData, setFormData] = useState({
    email: ''
  })
  const [showPayment, setShowPayment] = useState(false)
  const [currentQrData, setCurrentQrData] = useState<string>('')
  const [cart, setCart] = useState<any[]>([])
  const [showCart, setShowCart] = useState(false)
  const [cartItems, setCartItems] = useState<any[]>([])
  const [quantities, setQuantities] = useState<{[key: string]: number}>({})

  // Check for existing session on mount
  useEffect(() => {
    const savedUser = localStorage.getItem('usim_user')
    if (savedUser) {
      setIsLoggedIn(true)
      setUser(savedUser)
    }
  }, [])

  // User management system
  const [users, setUsers] = useState<{username: string, password: string, role: string}[]>([
    { username: 'admin', password: 'admin123', role: 'admin' }
  ])
  const [showUserManagement, setShowUserManagement] = useState(false)
  const [newUser, setNewUser] = useState({ username: '', password: '', role: 'agent' })

  // Load users from localStorage
  useEffect(() => {
    const savedUsers = localStorage.getItem('usim_users')
    if (savedUsers) {
      setUsers(JSON.parse(savedUsers))
    }
  }, [])

  // Save users to localStorage
  const saveUsers = (userList: {username: string, password: string, role: string}[]) => {
    localStorage.setItem('usim_users', JSON.stringify(userList))
    setUsers(userList)
  }

  // Simple authentication with user database
  const handleLogin = (username: string, password: string) => {
    const foundUser = users.find(u => u.username === username && u.password === password)
    if (foundUser) {
      setIsLoggedIn(true)
      setUser(username)
      localStorage.setItem('usim_user', username)
      localStorage.setItem('usim_user_role', foundUser.role)
    } else {
      alert('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!')
    }
  }

  // Add new user
  const addUser = () => {
    if (newUser.username && newUser.password) {
      const updatedUsers = [...users, newUser]
      saveUsers(updatedUsers)
      setNewUser({ username: '', password: '', role: 'agent' })
      alert('ƒê√£ th√™m user th√†nh c√¥ng!')
    } else {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!')
    }
  }

  // Remove user
  const removeUser = (username: string) => {
    if (username === 'admin') {
      alert('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin!')
      return
    }
    const updatedUsers = users.filter(u => u.username !== username)
    saveUsers(updatedUsers)
    alert('ƒê√£ x√≥a user th√†nh c√¥ng!')
  }

  const handleLogout = () => {
    setIsLoggedIn(false)
    setUser('')
    localStorage.removeItem('usim_user')
    localStorage.removeItem('usim_user_role')
    // Reset all states
    setSelectedCountry('')
    setSearchDays('')
    setShowForm(false)
    setSelectedProduct(null)
    setShowPayment(false)
    setCurrentQrData('')
    setShowUserManagement(false)
  }

  // Check if current user is admin
  const [isAdmin, setIsAdmin] = useState(false)

  useEffect(() => {
    if (typeof window !== 'undefined') {
      setIsAdmin(localStorage.getItem('usim_user_role') === 'admin')
    }
  }, [])

  // Cart functions
  const addToCart = (product: any, type: 'esim' | 'physical', quantity: number = 1) => {
    if (quantity <= 0) return

    const cartItem = {
      ...product,
      cartType: type,
      quantity: quantity,
      id: `${product[2]}_${type}_${Date.now()}`
    }

    setCart(prevCart => {
      const existingItem = prevCart.find(item =>
        item[2] === product[2] && item.cartType === type
      )

      if (existingItem) {
        return prevCart.map(item =>
          item[2] === product[2] && item.cartType === type
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      } else {
        return [...prevCart, cartItem]
      }
    })

    alert(`ƒê√£ th√™m ${quantity} x ${product[2]} (${type === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'}) v√†o gi·ªè h√†ng!`)
  }

  const removeFromCart = (itemId: string) => {
    setCart(prevCart => prevCart.filter(item => item.id !== itemId))
  }

  const updateQuantity = (itemId: string, newQuantity: number) => {
    if (newQuantity <= 0) {
      removeFromCart(itemId)
      return
    }

    setCart(prevCart =>
      prevCart.map(item =>
        item.id === itemId ? { ...item, quantity: newQuantity } : item
      )
    )
  }

  const getCartTotal = () => {
    return cart.reduce((total, item) => {
      const price = parseFloat(item[3]) * 27000
      return total + (price * item.quantity)
    }, 0)
  }

  const clearCart = () => {
    setCart([])
  }

  // Product quantity management (for adding to cart)
  const getProductQuantity = (productId: string, type: string) => {
    return quantities[`${productId}_${type}`] || 1
  }

  const updateProductQuantity = (productId: string, type: string, newQuantity: number) => {
    if (newQuantity < 1) newQuantity = 1
    if (newQuantity > 99) newQuantity = 99 // Max 99 items

    setQuantities(prev => ({
      ...prev,
      [`${productId}_${type}`]: newQuantity
    }))
  }

  const incrementProductQuantity = (productId: string, type: string) => {
    const current = getProductQuantity(productId, type)
    updateProductQuantity(productId, type, current + 1)
  }

  const decrementProductQuantity = (productId: string, type: string) => {
    const current = getProductQuantity(productId, type)
    if (current > 1) {
      updateProductQuantity(productId, type, current - 1)
    }
  }

  useEffect(() => {
    fetch('/api/data')
      .then(res => res.json())
      .then(setData)
  }, [])

  // Generate QR when payment modal opens
  useEffect(() => {
    const generateQrForPayment = async () => {
      if (showPayment && selectedProduct && !currentQrData) {
        // Try API first, fallback to original QR
        const qrData = await generateVietQr(Math.round(parseFloat(selectedProduct[3]) * 27000))
        setCurrentQrData(qrData || bankConfig.qrTemplate)
      }
    }
    generateQrForPayment()
  }, [showPayment, selectedProduct, currentQrData])

  const uniqueCountries = Array.from(new Set(data.map(item => item[1].replace(/[^\x00-\x7F]+/g, '').trim()))).sort()

  // VietQR API Integration with real credentials
  const generateVietQr = async (amount: number) => {
    try {
      const response = await fetch('https://api.vietqr.io/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer 9b443b3a-18b7-417e-a15b-9fdf0db9d0c5',
          'x-client-id': '851d88da-09cb-47b6-8934-0da9166568b7'
        },
        body: JSON.stringify({
          bank: 'BIDV',
          account: '8864555896',
          amount: amount,
          description: `Thanh toan SIM - ${selectedProduct?.[2]}`,
          template: 'compact'
        })
      })

      if (response.ok) {
        const data = await response.json()
        console.log('VietQR API Response:', data)
        return data.qrData || data.qr_string || data.qr
      } else {
        console.log('VietQR API Error:', response.status, response.statusText)
      }
    } catch (error) {
      console.log('VietQR API failed:', error)
    }

    // Fallback to local generation
    console.log('Using fallback QR generation')
    return generateQrData(amount)
  }

  const getFlagUrl = (country: string) => {
    const flagMap: { [key: string]: string } = {
      'Australia': 'au',
      'Austria': 'at',
      'Belgium': 'be',
      'Brazil': 'br',
      'Canada': 'ca',
      'China': 'cn',
      'Denmark': 'dk',
      'Europe': 'eu',
      'Europe(42countries)': 'eu',
      'Finland': 'fi',
      'France': 'fr',
      'Guam': 'gu',
      'Germany': 'de',
      'Greece': 'gr',
      'Hong Kong': 'hk',
      'HongKong': 'hk',
      'Hungary': 'hu',
      'Iceland': 'is',
      'India': 'in',
      'Indonesia': 'id',
      'Ireland': 'ie',
      'Israel': 'il',
      'Italy': 'it',
      'Japan': 'jp',
      'Jordan': 'jo',
      'Kenya': 'ke',
      'Korea': 'kr',
      'South Korea': 'kr',
      'Lebanon': 'lb',
      'Luxembourg': 'lu',
      'Macao': 'mo',
      'Macau': 'mo',
      'Malaysia': 'my',
      'Mexico': 'mx',
      'Netherlands': 'nl',
      'New Zealand': 'nz',
      'Norway': 'no',
      'Pakistan': 'pk',
      'Philippines': 'ph',
      'Poland': 'pl',
      'Portugal': 'pt',
      'Romania': 'ro',
      'Russia': 'ru',
      'Saipan': 'mp',
      'Saudi Arabia': 'sa',
      'Singapore': 'sg',
      'South Africa': 'za',
      'Spain': 'es',
      'Sweden': 'se',
      'Switzerland': 'ch',
      'Taiwan': 'tw',
      'Thailand': 'th',
      'Turkey': 'tr',
      'Ukraine': 'ua',
      'United Arab Emirates': 'ae',
      'United Kingdom': 'gb',
      'United States': 'us',
      'Vietnam': 'vn',
      'Viet Nam': 'vn',
      'VietNam': 'vn',
      'Laos': 'la',
      'Cambodia': 'kh',
    }
    const code = flagMap[country] || 'us' // default to US
    return `https://flagcdn.com/w40/${code}.png`
  }

  const countryData = data.filter(item =>
    item[1].replace(/[^\x00-\x7F]+/g, '').trim() === selectedCountry
  )
  const uniqueDays = Array.from(new Set(countryData.map(item => item[5]))).sort((a, b) => a - b)
  const filteredData = searchDays ? countryData.filter(item =>
    item[5].toString() === searchDays
  ) : countryData

  const Modal = () => (
    <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-100">
        <div className="flex items-center mb-6">
          <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mr-4">
            <span className="text-white text-xl">üì±</span>
          </div>
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Order Form</h2>
            <p className="text-gray-600 text-sm">for {selectedProduct?.[2]}</p>
          </div>
        </div>
        <form onSubmit={(e) => {
          e.preventDefault()
          setShowForm(false)
          setShowPayment(true)
          setFormData({ email: '' })
        }}>
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">‚úâÔ∏è Email</label>
              <input
                type="email"
                value={formData.email}
                onChange={e => setFormData({...formData, email: e.target.value})}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200"
                placeholder="Enter your email"
                required
              />
            </div>
          </div>
          <div className="flex justify-end space-x-3 mt-8">
            <button
              type="button"
              onClick={() => {
                setShowForm(false)
                setCurrentQrData('')
              }}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl transition-all duration-200 font-semibold"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white py-3 px-6 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
            >
              üöÄ Submit Order
            </button>
          </div>
        </form>
      </div>
    </div>
  )

  // Show login page if not authenticated
  if (!isLoggedIn) {
    return <LoginPage onLogin={handleLogin} />
  }

  // If authenticated, redirect to countries page
  if (typeof window !== 'undefined') {
    window.location.href = '/countries'
    return null
  }

  return null

  // BIDV VietQR Configuration
  const bankConfig = {
    accountNumber: '8864555896',
    bankName: 'BIDV',
    accountHolder: 'DAO VIET ANH',
    bankCode: 'BIDV',
    qrTemplate: '00020101021238540010A00000072701240006970418011088645558960208QRIBFTTA53037045405100005802VN63040517',
  }

  // Generate QR data with dynamic amount
  const generateQrData = (amount: number) => {
    const amountStr = Math.round(amount).toString()
    const amountLength = amountStr.length.toString().padStart(2, '0')
    const amountField = `54${amountLength}${amountStr}`
    return bankConfig.qrTemplate.replace('540510000', amountField)
  }

  const [data, setData] = useState<any[]>([])
  const [selectedCountry, setSelectedCountry] = useState('')
  const [searchDays, setSearchDays] = useState('')
  const [showForm, setShowForm] = useState(false)
  const [selectedProduct, setSelectedProduct] = useState<any>(null)
  const [formData, setFormData] = useState({
    email: ''
  })
  const [showPayment, setShowPayment] = useState(false)
  const [currentQrData, setCurrentQrData] = useState<string>('')
  const [cart, setCart] = useState<any[]>([])
  const [showCart, setShowCart] = useState(false)
  const [cartItems, setCartItems] = useState<any[]>([])
  const [quantities, setQuantities] = useState<{[key: string]: number}>({})

  // Check for existing session on mount
  useEffect(() => {
    const savedUser = localStorage.getItem('usim_user')
    if (savedUser) {
      setIsLoggedIn(true)
      setUser(savedUser)
    }
  }, [])

  // User management system
  const [users, setUsers] = useState<{username: string, password: string, role: string}[]>([
    { username: 'admin', password: 'admin123', role: 'admin' }
  ])
  const [showUserManagement, setShowUserManagement] = useState(false)
  const [newUser, setNewUser] = useState({ username: '', password: '', role: 'agent' })

  // Load users from localStorage
  useEffect(() => {
    const savedUsers = localStorage.getItem('usim_users')
    if (savedUsers) {
      setUsers(JSON.parse(savedUsers))
    }
  }, [])

  // Save users to localStorage
  const saveUsers = (userList: {username: string, password: string, role: string}[]) => {
    localStorage.setItem('usim_users', JSON.stringify(userList))
    setUsers(userList)
  }

  // Simple authentication with user database
  const handleLogin = (username: string, password: string) => {
    const foundUser = users.find(u => u.username === username && u.password === password)
    if (foundUser) {
      setIsLoggedIn(true)
      setUser(username)
      localStorage.setItem('usim_user', username)
      localStorage.setItem('usim_user_role', foundUser.role)
    } else {
      alert('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!')
    }
  }

  // Add new user
  const addUser = () => {
    if (newUser.username && newUser.password) {
      const updatedUsers = [...users, newUser]
      saveUsers(updatedUsers)
      setNewUser({ username: '', password: '', role: 'agent' })
      alert('ƒê√£ th√™m user th√†nh c√¥ng!')
    } else {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!')
    }
  }

  // Remove user
  const removeUser = (username: string) => {
    if (username === 'admin') {
      alert('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin!')
      return
    }
    const updatedUsers = users.filter(u => u.username !== username)
    saveUsers(updatedUsers)
    alert('ƒê√£ x√≥a user th√†nh c√¥ng!')
  }

  const handleLogout = () => {
    setIsLoggedIn(false)
    setUser('')
    localStorage.removeItem('usim_user')
    localStorage.removeItem('usim_user_role')
    // Reset all states
    setSelectedCountry('')
    setSearchDays('')
    setShowForm(false)
    setSelectedProduct(null)
    setShowPayment(false)
    setCurrentQrData('')
    setShowUserManagement(false)
  }

  // Check if current user is admin
  const [isAdmin, setIsAdmin] = useState(false)

  useEffect(() => {
    if (typeof window !== 'undefined') {
      setIsAdmin(localStorage.getItem('usim_user_role') === 'admin')
    }
  }, [])

  // Cart functions
  const addToCart = (product: any, type: 'esim' | 'physical', quantity: number = 1) => {
    if (quantity <= 0) return

    const cartItem = {
      ...product,
      cartType: type,
      quantity: quantity,
      id: `${product[2]}_${type}_${Date.now()}`
    }

    setCart(prevCart => {
      const existingItem = prevCart.find(item =>
        item[2] === product[2] && item.cartType === type
      )

      if (existingItem) {
        return prevCart.map(item =>
          item[2] === product[2] && item.cartType === type
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      } else {
        return [...prevCart, cartItem]
      }
    })

    alert(`ƒê√£ th√™m ${quantity} x ${product[2]} (${type === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'}) v√†o gi·ªè h√†ng!`)
  }

  const removeFromCart = (itemId: string) => {
    setCart(prevCart => prevCart.filter(item => item.id !== itemId))
  }

  const updateQuantity = (itemId: string, newQuantity: number) => {
    if (newQuantity <= 0) {
      removeFromCart(itemId)
      return
    }

    setCart(prevCart =>
      prevCart.map(item =>
        item.id === itemId ? { ...item, quantity: newQuantity } : item
      )
    )
  }

  const getCartTotal = () => {
    return cart.reduce((total, item) => {
      const price = parseFloat(item[3]) * 27000
      return total + (price * item.quantity)
    }, 0)
  }

  const clearCart = () => {
    setCart([])
  }

  // Product quantity management (for adding to cart)
  const getProductQuantity = (productId: string, type: string) => {
    return quantities[`${productId}_${type}`] || 1
  }

  const updateProductQuantity = (productId: string, type: string, newQuantity: number) => {
    if (newQuantity < 1) newQuantity = 1
    if (newQuantity > 99) newQuantity = 99 // Max 99 items

    setQuantities(prev => ({
      ...prev,
      [`${productId}_${type}`]: newQuantity
    }))
  }

  const incrementProductQuantity = (productId: string, type: string) => {
    const current = getProductQuantity(productId, type)
    updateProductQuantity(productId, type, current + 1)
  }

  const decrementProductQuantity = (productId: string, type: string) => {
    const current = getProductQuantity(productId, type)
    if (current > 1) {
      updateProductQuantity(productId, type, current - 1)
    }
  }

  useEffect(() => {
    fetch('/api/data')
      .then(res => res.json())
      .then(setData)
  }, [])

  // Generate QR when payment modal opens
  useEffect(() => {
    const generateQrForPayment = async () => {
      if (showPayment && selectedProduct && !currentQrData) {
        // Try API first, fallback to original QR
        const qrData = await generateVietQr(Math.round(parseFloat(selectedProduct[3]) * 27000))
        setCurrentQrData(qrData || bankConfig.qrTemplate)
      }
    }
    generateQrForPayment()
  }, [showPayment, selectedProduct, currentQrData])

  const uniqueCountries = Array.from(new Set(data.map(item => item[1].replace(/[^\x00-\x7F]+/g, '').trim()))).sort()

  // VietQR API Integration with real credentials
  const generateVietQr = async (amount: number) => {
    try {
      const response = await fetch('https://api.vietqr.io/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer 9b443b3a-18b7-417e-a15b-9fdf0db9d0c5',
          'x-client-id': '851d88da-09cb-47b6-8934-0da9166568b7'
        },
        body: JSON.stringify({
          bank: 'BIDV',
          account: '8864555896',
          amount: amount,
          description: `Thanh toan SIM - ${selectedProduct?.[2]}`,
          template: 'compact'
        })
      })

      if (response.ok) {
        const data = await response.json()
        console.log('VietQR API Response:', data)
        return data.qrData || data.qr_string || data.qr
      } else {
        console.log('VietQR API Error:', response.status, response.statusText)
      }
    } catch (error) {
      console.log('VietQR API failed:', error)
    }

    // Fallback to local generation
    console.log('Using fallback QR generation')
    return generateQrData(amount)
  }

  const getFlagUrl = (country: string) => {
    const flagMap: { [key: string]: string } = {
      'Australia': 'au',
      'Austria': 'at',
      'Belgium': 'be',
      'Brazil': 'br',
      'Canada': 'ca',
      'China': 'cn',
      'Denmark': 'dk',
      'Europe': 'eu',
      'Europe(42countries)': 'eu',
      'Finland': 'fi',
      'France': 'fr',
      'Guam': 'gu',
      'Germany': 'de',
      'Greece': 'gr',
      'Hong Kong': 'hk',
      'HongKong': 'hk',
      'Hungary': 'hu',
      'Iceland': 'is',
      'India': 'in',
      'Indonesia': 'id',
      'Ireland': 'ie',
      'Israel': 'il',
      'Italy': 'it',
      'Japan': 'jp',
      'Jordan': 'jo',
      'Kenya': 'ke',
      'Korea': 'kr',
      'South Korea': 'kr',
      'Lebanon': 'lb',
      'Luxembourg': 'lu',
      'Macao': 'mo',
      'Macau': 'mo',
      'Malaysia': 'my',
      'Mexico': 'mx',
      'Netherlands': 'nl',
      'New Zealand': 'nz',
      'Norway': 'no',
      'Pakistan': 'pk',
      'Philippines': 'ph',
      'Poland': 'pl',
      'Portugal': 'pt',
      'Romania': 'ro',
      'Russia': 'ru',
      'Saipan': 'mp',
      'Saudi Arabia': 'sa',
      'Singapore': 'sg',
      'South Africa': 'za',
      'Spain': 'es',
      'Sweden': 'se',
      'Switzerland': 'ch',
      'Taiwan': 'tw',
      'Thailand': 'th',
      'Turkey': 'tr',
      'Ukraine': 'ua',
      'United Arab Emirates': 'ae',
      'United Kingdom': 'gb',
      'United States': 'us',
      'Vietnam': 'vn',
      'Viet Nam': 'vn',
      'VietNam': 'vn',
      'Laos': 'la',
      'Cambodia': 'kh',
    }
    const code = flagMap[country] || 'us' // default to US
    return `https://flagcdn.com/w40/${code}.png`
  }

  const countryData = data.filter(item =>
    item[1].replace(/[^\x00-\x7F]+/g, '').trim() === selectedCountry
  )
  const uniqueDays = Array.from(new Set(countryData.map(item => item[5]))).sort((a, b) => a - b)
  const filteredData = searchDays ? countryData.filter(item =>
    item[5].toString() === searchDays
  ) : countryData

  const Modal = () => (
    <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full border border-gray-100">
        <div className="flex items-center mb-6">
          <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full flex items-center justify-center mr-4">
            <span className="text-white text-xl">üì±</span>
          </div>
          <div>
            <h2 className="text-2xl font-bold text-gray-800">Order Form</h2>
            <p className="text-gray-600 text-sm">for {selectedProduct?.[2]}</p>
          </div>
        </div>
        <form onSubmit={(e) => {
          e.preventDefault()
          setShowForm(false)
          setShowPayment(true)
          setFormData({ email: '' })
        }}>
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">‚úâÔ∏è Email</label>
              <input
                type="email"
                value={formData.email}
                onChange={e => setFormData({...formData, email: e.target.value})}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200"
                placeholder="Enter your email"
                required
              />
            </div>
          </div>
          <div className="flex justify-end space-x-3 mt-8">
            <button
              type="button"
              onClick={() => {
                setShowForm(false)
                setCurrentQrData('')
              }}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-6 rounded-xl transition-all duration-200 font-semibold"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white py-3 px-6 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
            >
              üöÄ Submit Order
            </button>
          </div>
        </form>
      </div>
    </div>
  )

  // Show login page if not authenticated
  if (!isLoggedIn) {
    return <LoginPage onLogin={handleLogin} />
  }

  // If authenticated, redirect to countries page
  if (typeof window !== 'undefined') {
    window.location.href = '/countries'
    return null
  }

  return null

  // Legacy code below (keeping for reference)
  if (!selectedCountry) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-100 py-12">
        <div className="container mx-auto px-4 max-w-7xl">
          <div className="text-center mb-16">
            <div className="flex justify-end mb-4 space-x-2">
              {isAdmin && (
                <button
                  onClick={() => setShowUserManagement(true)}
                  className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
                >
                  üë• Manage Users
                </button>
              )}
              <button
                onClick={handleLogout}
                className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md text-sm"
              >
                üö™ Logout ({user})
              </button>
            </div>
            <h1 className="text-5xl font-bold text-gray-800 mb-4 drop-shadow-sm">üåç Select Your Country</h1>
            <p className="text-xl text-gray-600 max-w-2xl mx-auto">Choose a country to explore available SIM card products and services</p>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {uniqueCountries.map((country, index) => {
              const countryParts = country.split('/');
              return (
                <div
                  key={index}
                  className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 hover:scale-102 flex flex-col items-center border border-gray-100 group"
                  onClick={() => setSelectedCountry(country)}
                >
                  <div className="flex mb-4 space-x-1 justify-center">
                    {countryParts.map((part, i) => (
                      <img
                        key={i}
                        src={getFlagUrl(part.trim())}
                        alt={`${part.trim()} flag`}
                        className="w-12 h-8 rounded-md shadow-sm border border-gray-200 group-hover:border-blue-300 transition-all duration-300"
                      />
                    ))}
                  </div>
                  <h2 className="text-lg font-bold text-gray-800 text-center leading-tight group-hover:text-blue-600 transition-colors duration-300">{country}</h2>
                  <div className="mt-3 w-8 h-1 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>
              );
            })}
          </div>

          {showForm && <Modal />}
          {showUserManagement && (
            <UserManagementModal
              users={users}
              newUser={newUser}
              setNewUser={setNewUser}
              addUser={addUser}
              removeUser={removeUser}
              onClose={() => setShowUserManagement(false)}
            />
          )}
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 py-8">
      <div className="container mx-auto px-4 max-w-7xl">
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-12 bg-white p-6 rounded-2xl shadow-lg">
          <div>
            <h1 className="text-4xl font-bold text-gray-800 mb-2">üì± Products for {selectedCountry}</h1>
            <p className="text-gray-600">Browse and order SIM cards with ease</p>
            <p className="text-sm text-gray-500 mt-1">Welcome, {user}!</p>
          </div>
          <div className="flex space-x-3 mt-4 sm:mt-0">
            <button
              onClick={() => setSelectedCountry('')}
              className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
            >
              ‚Üê Back to Countries
            </button>
            <button
              onClick={() => setShowCart(true)}
              className="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md relative"
            >
              üõí Gi·ªè h√†ng
              {cart.length > 0 && (
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center">
                  {cart.length}
                </span>
              )}
            </button>
            {isAdmin && (
              <button
                onClick={() => setShowUserManagement(true)}
                className="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
              >
                üë• Manage Users
              </button>
            )}
            <button
              onClick={handleLogout}
              className="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md"
            >
              üö™ Logout
            </button>
          </div>
        </div>

        {/* Search Section */}
        <div className="bg-white p-8 rounded-2xl shadow-lg mb-8 border border-gray-100">
          <h2 className="text-2xl font-semibold mb-6 text-gray-800 flex items-center">
            üîç Filter Products
          </h2>
          <div className="max-w-md">
            <label className="block text-sm font-semibold text-gray-700 mb-3">Select Duration</label>
            <select
              value={searchDays}
              onChange={e => setSearchDays(e.target.value)}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition-all duration-200 text-gray-700"
            >
              <option value="">All Days</option>
              {uniqueDays.map(day => (
                <option key={day} value={day}>‚è∞ {day} days</option>
              ))}
            </select>
          </div>
        </div>

        {/* Table */}
        <div className="bg-white rounded-2xl shadow-xl overflow-x-auto border border-gray-100">
          <table className="table-auto w-full">
            <thead className="bg-gradient-to-r from-blue-600 to-indigo-600">
              <tr>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Type</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Country</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Name</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Price VND</th>
                <th className="hidden md:table-cell px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Operations</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Days</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Esim</th>
                <th className="px-2 sm:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Sim V·∫≠t L√Ω</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filteredData.map((item: any, index: number) => (
                <tr key={index} className={`hover:bg-blue-50 transition-colors duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">{item[0]}</td>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[1].replace(/[^\x00-\x7F]+/g, '').trim()}</td>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">{item[2]}</td>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item[3]}</td>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">{(parseFloat(item[3]) * 27000).toLocaleString()} VND</td>
                  <td className="hidden md:table-cell px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[4]}</td>
                  <td className="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item[5]} days</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <div className="flex flex-col space-y-3">
                      {/* eSIM Section */}
                      <div className="flex items-center space-x-2">
                        <span className="text-xs font-medium text-gray-600 w-12">eSIM:</span>
                        <div className="flex items-center space-x-1">
                          <button
                            onClick={() => decrementProductQuantity(item[2], 'esim')}
                            className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                          >
                            -
                          </button>
                          <span className="w-8 text-center text-sm font-medium">
                            {getProductQuantity(item[2], 'esim')}
                          </span>
                          <button
                            onClick={() => incrementProductQuantity(item[2], 'esim')}
                            className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                          >
                            +
                          </button>
                        </div>
                        <button
                          className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                          onClick={() => addToCart(item, 'esim', getProductQuantity(item[2], 'esim'))}
                        >
                          üõí Th√™m
                        </button>
                      </div>

                      {/* Physical SIM Section */}
                      <div className="flex items-center space-x-2">
                        <span className="text-xs font-medium text-gray-600 w-12">V·∫≠t l√Ω:</span>
                        <div className="flex items-center space-x-1">
                          <button
                            onClick={() => decrementProductQuantity(item[2], 'physical')}
                            className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                          >
                            -
                          </button>
                          <span className="w-8 text-center text-sm font-medium">
                            {getProductQuantity(item[2], 'physical')}
                          </span>
                          <button
                            onClick={() => incrementProductQuantity(item[2], 'physical')}
                            className="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 text-xs flex items-center justify-center"
                          >
                            +
                          </button>
                        </div>
                        <button
                          className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs py-1 px-3 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                          onClick={() => addToCart(item, 'physical', getProductQuantity(item[2], 'physical'))}
                        >
                          üõí Th√™m
                        </button>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                      <button
                        className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                        onClick={() => addToCart(item, 'physical')}
                      >
                        üõí Th√™m v√†o gi·ªè
                      </button>
                      <button
                        className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md"
                        onClick={() => alert(`Physical Sim Bulk Order for ${item[2]}`)}
                      >
                        üì¶ Oder l√¥
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      {showForm && <Modal />}

      {/* Payment Modal */}
      {showPayment && (
        <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-100">
            <div className="text-center mb-6">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span className="text-green-600 text-2xl">‚úÖ</span>
              </div>
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Order Confirmed!</h2>
              <p className="text-gray-600">Please scan the QR code to complete your payment</p>
            </div>

            <div className="flex justify-center mb-6">
              <div className="bg-gray-100 p-4 rounded-xl">
                {(() => {
                  const amount = Math.round(getCartTotal())

                  if (!currentQrData) {
                    return (
                      <div className="text-center">
                        <div className="w-48 h-48 mx-auto border-2 border-gray-200 rounded-lg flex items-center justify-center">
                          <div className="text-gray-500">ƒêang t·∫°o QR code...</div>
                        </div>
                        <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                        <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                      </div>
                    )
                  }

                  return (
                    <div className="text-center">
                      <img
                        src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentQrData)}&ecc=M`}
                        alt="BIDV VietQR Code"
                        className="w-48 h-48 mx-auto border-2 border-red-200 rounded-lg"
                        onError={(e) => {
                          console.log('QR Code failed to load, trying alternative...')
                          e.currentTarget.src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(currentQrData)}`
                        }}
                      />
                      <p className="text-xs text-red-600 mt-2 font-semibold">BIDV VietQR Code</p>
                      <p className="text-xs text-green-600 mt-1 font-bold">S·ªë ti·ªÅn: {amount.toLocaleString()} VND</p>
                      <p className="text-xs text-gray-500 mt-1">Thanh to√°n qua BIDV VietQR</p>
                    </div>
                  )
                })()}
              </div>
            </div>

            <div className="mb-6">
              <h3 className="text-lg font-bold text-gray-800 mb-4">Chi ti·∫øt ƒë∆°n h√†ng</h3>
              <div className="bg-gray-50 p-4 rounded-xl mb-4">
                {cart.map((item, index) => {
                  const price = parseFloat(item[3]) * 27000
                  const subtotal = price * item.quantity
                  return (
                    <div key={index} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                      <div>
                        <p className="font-medium text-gray-800">{item[2]}</p>
                        <p className="text-sm text-gray-600">
                          {item.cartType === 'esim' ? 'eSIM' : 'Sim V·∫≠t L√Ω'} √ó {item.quantity}
                        </p>
                      </div>
                      <p className="font-semibold text-green-600">{subtotal.toLocaleString()} VND</p>
                    </div>
                  )
                })}
              </div>

              <div className="text-center">
                <p className="text-sm text-gray-600 mb-2">Thanh to√°n BIDV VietQR:</p>
                <p className="text-xs text-gray-500">T√†i kho·∫£n: {bankConfig.accountNumber}</p>
                <p className="text-xs text-gray-500">Ng√¢n h√†ng: {bankConfig.bankName}</p>
                <p className="text-xs text-red-600 font-bold">Ch·ªß t√†i kho·∫£n: {bankConfig.accountHolder}</p>
                <p className="text-lg text-green-600 font-bold mt-2">T·ªïng ti·ªÅn: {getCartTotal().toLocaleString()} VND</p>
                <p className="text-xs text-red-600 mt-2">üè¶ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
              </div>
            </div>

            <div className="flex justify-center space-x-4">
              <button
                onClick={() => {
                  setShowPayment(false)
                  setCurrentQrData('')
                  clearCart()
                  alert('C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n! ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong 24h.')
                }}
                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold transform hover:scale-105 shadow-lg"
              >
                ‚úÖ ƒê√£ thanh to√°n
              </button>
              <button
                onClick={() => {
                  setShowPayment(false)
                  setCurrentQrData('')
                }}
                className="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white py-3 px-8 rounded-xl transition-all duration-200 font-semibold"
              >
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}